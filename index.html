<!DOCTYPE html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <title>Mirza Ping - تست سرعت اینترنت</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(
          135deg,
          #1a1a2e 0%,
          #16213e 50%,
          #0f3460 100%
        );
        min-height: 100vh;
        color: #fff;
        overflow-x: hidden;
        -webkit-font-smoothing: antialiased;
        text-rendering: optimizeLegibility;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 0;
        margin-bottom: 26px;
        gap: 12px;
      }
      .logo-section {
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 0;
      }
      .logo {
        width: 58px;
        height: 58px;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 14px;
        border: 2px solid rgba(138, 43, 226, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        font-weight: 800;
        box-shadow: 0 8px 32px rgba(138, 43, 226, 0.2);
        flex: 0 0 auto;
      }
      .site-title {
        font-size: 32px;
        font-weight: 800;
        background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .lang-switch {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 2px solid rgba(138, 43, 226, 0.3);
        padding: 10px 16px;
        border-radius: 999px;
        cursor: pointer;
        transition: all 0.2s;
        color: #fff;
        font-size: 13px;
        flex: 0 0 auto;
      }
      .lang-switch:hover {
        background: rgba(138, 43, 226, 0.28);
        transform: translateY(-1px);
      }

      .glass-card {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(20px);
        border-radius: 26px;
        padding: 34px;
        border: 2px solid rgba(138, 43, 226, 0.2);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        margin-bottom: 26px;
      }

      .info-cards {
        display: grid;
        grid-template-columns: 1fr;
        gap: 14px;
        margin-bottom: 10px;
      }
      .info-card {
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(15px);
        border-radius: 18px;
        padding: 16px;
        border: 1px solid rgba(138, 43, 226, 0.3);
        text-align: center;
        transition: all 0.2s;
      }
      .info-label {
        font-size: 13px;
        color: #a8a8a8;
        margin-bottom: 8px;
      }
      .info-value {
        font-size: 16px;
        font-weight: 800;
        color: #8fb3ff;
        word-break: break-word;
      }

      .speed-display {
        text-align: center;
        margin: 26px 0 18px;
      }
      .main-speed {
        font-size: 64px;
        font-weight: 900;
        background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        line-height: 1;
        letter-spacing: -1px;
        margin-bottom: 8px;
      }
      .speed-label {
        font-size: 18px;
        color: #a8a8a8;
      }

      .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 14px;
        margin-bottom: 18px;
      }
      .metric-box {
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(15px);
        border-radius: 18px;
        padding: 18px;
        border: 1px solid rgba(138, 43, 226, 0.3);
        text-align: center;
      }
      .metric-value {
        font-size: 30px;
        font-weight: 900;
        color: #8fb3ff;
        margin-bottom: 4px;
      }
      .metric-label {
        font-size: 13px;
        color: #a8a8a8;
      }

      .chart-container {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(15px);
        border-radius: 18px;
        padding: 18px;
        border: 1px solid rgba(138, 43, 226, 0.3);
        margin-bottom: 16px;
        height: 260px;
        position: relative;
      }
      canvas {
        width: 100% !important;
        height: 100% !important;
      }

      .progress-bar {
        width: 100%;
        height: 8px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 999px;
        overflow: hidden;
        margin: 18px 0 14px;
      }
      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        width: 0%;
        transition: width 0.25s;
      }

      .status-text {
        text-align: center;
        color: #a8a8a8;
        font-size: 14px;
        margin-top: 10px;
      }

      .start-btn {
        background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
        border: none;
        padding: 16px 44px;
        border-radius: 999px;
        font-size: 18px;
        font-weight: 900;
        color: #fff;
        cursor: pointer;
        transition: transform 0.15s;
        box-shadow: 0 8px 26px rgba(102, 126, 234, 0.38);
        display: block;
        margin: 12px auto 0;
        width: min(420px, 100%);
      }
      .start-btn:active {
        transform: translateY(1px);
      }
      .start-btn:disabled {
        opacity: 0.55;
        cursor: not-allowed;
      }

      .debug {
        margin-top: 14px;
        padding: 12px 14px;
        border-radius: 14px;
        border: 1px solid rgba(138, 43, 226, 0.25);
        background: rgba(255, 255, 255, 0.06);
        font-size: 12px;
        color: rgba(234, 240, 255, 0.85);
        line-height: 1.6;
        white-space: pre-wrap;
        user-select: text;
        max-height: 220px;
        overflow: auto;
      }

      @media (max-width: 520px) {
        .container {
          padding: 14px;
        }
        header {
          padding: 10px 0;
          margin-bottom: 18px;
        }
        .logo {
          width: 48px;
          height: 48px;
          border-radius: 12px;
          font-size: 16px;
        }
        .site-title {
          font-size: 22px;
        }
        .glass-card {
          padding: 18px;
          border-radius: 20px;
        }
        .main-speed {
          font-size: 54px;
        }
        .speed-label {
          font-size: 16px;
        }
        .chart-container {
          height: 220px;
          padding: 14px;
        }
        .metric-value {
          font-size: 28px;
        }
        .start-btn {
          font-size: 17px;
          padding: 15px 20px;
        }
      }

      [dir="ltr"] {
        text-align: left;
      }
      [dir="ltr"] .info-card,
      [dir="ltr"] .metric-box,
      [dir="ltr"] .speed-display,
      [dir="ltr"] .status-text {
        text-align: center;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <header>
        <div class="logo-section">
          <div class="logo">MP</div>
          <div class="site-title" data-fa="میرزا پینگ" data-en="Mirza Ping">
            میرزا پینگ
          </div>
        </div>
        <button class="lang-switch" onclick="toggleLang()">
          <span data-fa="English" data-en="فارسی">English</span>
        </button>
      </header>

      <div class="glass-card">
        <div class="info-cards">
          <div class="info-card">
            <div class="info-label" data-fa="آدرس IP" data-en="IP Address">
              آدرس IP
            </div>
            <div class="info-value" id="ip">در حال بارگذاری...</div>
          </div>
        </div>

        <div class="speed-display">
          <div class="main-speed" id="mainSpeed">0</div>
          <div class="speed-label" data-fa="مگابیت بر ثانیه" data-en="Mbps">
            مگابیت بر ثانیه
          </div>
        </div>

        <div class="metrics-grid">
          <div class="metric-box">
            <div class="metric-value" id="ping">0</div>
            <div class="metric-label" data-fa="پینگ (ms)" data-en="Ping (ms)">
              پینگ (ms)
            </div>
          </div>
          <div class="metric-box">
            <div class="metric-value" id="download">0</div>
            <div
              class="metric-label"
              data-fa="دانلود (Mbps)"
              data-en="Download (Mbps)"
            >
              دانلود (Mbps)
            </div>
          </div>
          <div class="metric-box">
            <div class="metric-value" id="jitter">0</div>
            <div class="metric-label" data-fa="جیتر (ms)" data-en="Jitter (ms)">
              جیتر (ms)
            </div>
          </div>
        </div>

        <div class="chart-container"><canvas id="speedChart"></canvas></div>

        <div class="progress-bar">
          <div class="progress-fill" id="progress"></div>
        </div>

        <div
          class="status-text"
          id="status"
          data-fa="آماده برای شروع تست"
          data-en="Ready to start test"
        >
          آماده برای شروع تست
        </div>

        <button class="start-btn" id="startBtn" onclick="startTest()">
          <span data-fa="شروع تست" data-en="Start Test">شروع تست</span>
        </button>

        <div class="debug" id="debug">Debug: ready.</div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
      let currentLang = "fa";
      let isTestRunning = false;

      // === بدون Workers: تست از فایل‌های GitHub Pages ===
      // /assets/ping.bin (کوچک)
      // /assets/download.bin (بزرگ)
      const PING_URL = "./assets/ping.bin";
      const DOWNLOAD_URL = "./assets/download.bin";

      const dbgEl = document.getElementById("debug");
      function dbg(msg) {
        const t = new Date().toLocaleTimeString();
        dbgEl.textContent = (`[${t}] ${msg}\n` + dbgEl.textContent).slice(
          0,
          2600
        );
        console.log("[DBG]", msg);
      }

      // Chart
      let chartData = {
        labels: [],
        datasets: [
          {
            label: "Speed (Mbps)",
            data: [],
            borderColor: "#667eea",
            backgroundColor: "rgba(102, 126, 234, 0.1)",
            tension: 0.4,
            fill: true,
            pointRadius: 2.5,
          },
        ],
      };

      const ctx = document.getElementById("speedChart").getContext("2d");
      const chart = new Chart(ctx, {
        type: "line",
        data: chartData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: {
              beginAtZero: true,
              grid: { color: "rgba(255, 255, 255, 0.1)" },
              ticks: { color: "#a8a8a8", callback: (v) => v + " Mbps" },
            },
            x: {
              grid: { color: "rgba(255, 255, 255, 0.1)" },
              ticks: { color: "#a8a8a8" },
            },
          },
          animation: { duration: 0 },
        },
      });

      function toggleLang() {
        currentLang = currentLang === "fa" ? "en" : "fa";
        document.documentElement.setAttribute("lang", currentLang);
        document.documentElement.setAttribute(
          "dir",
          currentLang === "fa" ? "rtl" : "ltr"
        );
        document.querySelectorAll("[data-fa]").forEach((el) => {
          const text = el.getAttribute("data-" + currentLang);
          if (text) el.textContent = text;
        });
      }

      function sleep(ms) {
        return new Promise((r) => setTimeout(r, ms));
      }

      function fetchWithTimeout(url, timeoutMs = 8000, fetchOptions = {}) {
        const controller = new AbortController();
        const timer = setTimeout(() => controller.abort(), timeoutMs);
        return fetch(url, {
          ...fetchOptions,
          signal: controller.signal,
        }).finally(() => clearTimeout(timer));
      }

      function updateStatus(faText, enText) {
        const statusEl = document.getElementById("status");
        statusEl.setAttribute("data-fa", faText);
        statusEl.setAttribute("data-en", enText);
        statusEl.textContent = currentLang === "fa" ? faText : enText;
      }

      function pushChartPoint(speedMbps, startMs) {
        const elapsed = ((performance.now() - startMs) / 1000).toFixed(1);
        chartData.labels.push(elapsed + "s");
        chartData.datasets[0].data.push(Number(speedMbps.toFixed(2)));
        if (chartData.labels.length > 70) {
          chartData.labels.shift();
          chartData.datasets[0].data.shift();
        }
        chart.update();
      }

      // فقط IP از ipify
      async function getIP() {
        const ipEl = document.getElementById("ip");
        ipEl.textContent = "در حال شناسایی...";
        dbg("IP: fetching from ipify...");

        try {
          const r = await fetchWithTimeout(
            "https://api.ipify.org?format=json&t=" + Date.now(),
            6000,
            {
              cache: "no-store",
            }
          );
          if (!r.ok) throw new Error("HTTP_" + r.status);
          const d = await r.json();
          ipEl.textContent = d && d.ip ? d.ip : "Unknown";
          dbg("IP: ok " + (d.ip || "Unknown"));
        } catch (e) {
          ipEl.textContent = "Unknown";
          dbg("IP: fail " + (e?.message || e));
        }
      }

      async function measurePing() {
        updateStatus("در حال تست پینگ...", "Testing ping...");
        dbg("Ping: start");

        const pingResults = [];
        const iterations = 5;

        for (let i = 0; i < iterations; i++) {
          const start = performance.now();
          try {
            await fetchWithTimeout(PING_URL + "?t=" + Date.now(), 3800, {
              cache: "no-store",
            });
            const end = performance.now();
            const ping = end - start;
            pingResults.push(ping);
            document.getElementById("ping").textContent = ping.toFixed(0);
            dbg(`Ping sample ${i + 1}/${iterations}: ${ping.toFixed(0)}ms`);
          } catch (e) {
            dbg(
              `Ping sample ${i + 1}/${iterations}: FAIL (${e?.message || e})`
            );
          }
          if (i < iterations - 1) await sleep(450);
        }

        if (!pingResults.length) {
          document.getElementById("ping").textContent = "0";
          document.getElementById("jitter").textContent = "0";
          dbg("Ping: all failed");
          return;
        }

        const avgPing =
          pingResults.reduce((a, b) => a + b, 0) / pingResults.length;
        const jitter = Math.sqrt(
          pingResults
            .map((p) => (p - avgPing) * (p - avgPing))
            .reduce((a, b) => a + b, 0) / pingResults.length
        );

        document.getElementById("ping").textContent = avgPing.toFixed(0);
        document.getElementById("jitter").textContent = jitter.toFixed(1);
        dbg(
          `Ping: done avg=${avgPing.toFixed(0)}ms jitter=${jitter.toFixed(1)}ms`
        );
      }

      // ====== Download (FIXED): چند اتصال موازی + محاسبه پایدار ======
      function makeNoCacheUrl(base, extra) {
        const sep = base.includes("?") ? "&" : "?";
        return (
          base +
          sep +
          "t=" +
          Date.now() +
          "&r=" +
          Math.random() +
          (extra ? "&" + extra : "")
        );
      }

      async function measureDownload() {
        updateStatus("در حال تست سرعت دانلود...", "Testing download speed...");
        dbg("Download: start");

        const durationMs = 10000;
        const startMs = performance.now();

        // تعداد اتصال موازی (مثل speedtest). 4 معمولاً خوبه.
        const PARALLEL = 4;

        // شمارنده بایت برای هر تیک
        let bytesSinceTick = 0;
        const speeds = [];

        // ریست چارت
        chartData.labels = [];
        chartData.datasets[0].data = [];
        chart.update();

        // کنترل قطع دانلودها
        const controllers = Array.from(
          { length: PARALLEL },
          () => new AbortController()
        );

        // هر worker تا پایان زمان تست، پشت‌سرهم دانلود می‌کشد (اگر فایل تمام شد، دوباره fetch می‌کند)
        async function downloadWorker(i) {
          let round = 0;
          while (isTestRunning && performance.now() - startMs < durationMs) {
            const url = makeNoCacheUrl(
              DOWNLOAD_URL,
              "w=" + i + "&round=" + round++
            );
            try {
              const res = await fetch(url, {
                cache: "no-store",
                signal: controllers[i].signal,
              });
              if (!res.ok) throw new Error("HTTP_" + res.status);
              if (!res.body) throw new Error("STREAM_UNSUPPORTED");

              const reader = res.body.getReader();
              while (
                isTestRunning &&
                performance.now() - startMs < durationMs
              ) {
                const { value, done } = await reader.read();
                if (done) break;
                bytesSinceTick += value.byteLength;
              }
              try {
                reader.cancel();
              } catch {}
            } catch (e) {
              // اگر Abort شد، طبیعی است
              if (controllers[i].signal.aborted) break;
              dbg(`Download worker ${i} error: ${e?.message || e}`);
              // کمی مکث و تلاش مجدد
              await sleep(120);
            }
          }
        }

        // تایمر محاسبه سرعت هر 250ms (پایدار و دقیق‌تر)
        let lastTickMs = performance.now();
        const tickTimer = setInterval(() => {
          const now = performance.now();
          const sec = (now - lastTickMs) / 1000;
          if (sec <= 0) return;

          const speedMbps = (bytesSinceTick * 8) / (sec * 1e6);
          bytesSinceTick = 0;
          lastTickMs = now;

          // اگر هنوز داده‌ای نیومده، چارت رو اسپم نکن
          if (!isFinite(speedMbps)) return;

          speeds.push(speedMbps);
          document.getElementById("mainSpeed").textContent =
            speedMbps.toFixed(2);
          document.getElementById("download").textContent =
            speedMbps.toFixed(2);
          pushChartPoint(speedMbps, startMs);
        }, 250);

        // اجرای دانلودهای موازی
        const workers = [];
        for (let i = 0; i < PARALLEL; i++) workers.push(downloadWorker(i));

        // منتظر پایان زمان
        while (performance.now() - startMs < durationMs && isTestRunning) {
          await sleep(80);
        }

        // توقف دانلودها
        for (const c of controllers) {
          try {
            c.abort();
          } catch {}
        }

        // پاک کردن تایمر
        clearInterval(tickTimer);

        // منتظر بسته شدن workerها
        try {
          await Promise.allSettled(workers);
        } catch {}

        // میانگین سرعت (میانگین چند نمونه آخر، نوسان کمتر)
        if (speeds.length) {
          const tail = speeds.slice(Math.max(0, speeds.length - 20)); // 20 تیک آخر
          const avg = tail.reduce((a, b) => a + b, 0) / tail.length;
          document.getElementById("download").textContent = avg.toFixed(2);
          document.getElementById("mainSpeed").textContent = avg.toFixed(2);
        } else {
          document.getElementById("download").textContent = "0";
          document.getElementById("mainSpeed").textContent = "0";
        }

        dbg("Download: done");
      }

      async function startTest() {
        if (isTestRunning) return;

        const btn = document.getElementById("startBtn");
        const progress = document.getElementById("progress");

        isTestRunning = true;
        btn.disabled = true;

        document.getElementById("mainSpeed").textContent = "0";
        document.getElementById("ping").textContent = "0";
        document.getElementById("download").textContent = "0";
        document.getElementById("jitter").textContent = "0";
        progress.style.width = "0%";

        chartData.labels = [];
        chartData.datasets[0].data = [];
        chart.update();

        dbg("=== START TEST (NO UPLOAD) ===");
        dbg("STATIC_ASSETS=GitHub Pages");
        dbg("PING_URL=" + PING_URL);
        dbg("DOWNLOAD_URL=" + DOWNLOAD_URL);

        try {
          progress.style.width = "10%";
          await measurePing();
          progress.style.width = "35%";

          await sleep(350);

          progress.style.width = "40%";
          await measureDownload();
          progress.style.width = "100%";

          updateStatus(
            "تست با موفقیت انجام شد!",
            "Test completed successfully!"
          );
          dbg("=== DONE ===");
        } catch (e) {
          dbg("Test error: " + (e?.message || e));
          updateStatus("خطا در انجام تست", "Error during test");
        }

        isTestRunning = false;
        btn.disabled = false;
      }

      // init
      getIP();
    </script>
  </body>
</html>
