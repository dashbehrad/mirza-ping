<!DOCTYPE html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mirza Ping - تست سرعت اینترنت</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(
          135deg,
          #1a1a2e 0%,
          #16213e 50%,
          #0f3460 100%
        );
        min-height: 100vh;
        color: #fff;
        overflow-x: hidden;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 0;
        margin-bottom: 40px;
      }
      .logo-section {
        display: flex;
        align-items: center;
        gap: 15px;
      }
      .logo {
        width: 60px;
        height: 60px;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        border: 2px solid rgba(138, 43, 226, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        box-shadow: 0 8px 32px rgba(138, 43, 226, 0.2);
      }
      .site-title {
        font-size: 32px;
        font-weight: 700;
        background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      .lang-switch {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 2px solid rgba(138, 43, 226, 0.3);
        padding: 10px 20px;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s;
        color: #fff;
        font-size: 14px;
      }
      .lang-switch:hover {
        background: rgba(138, 43, 226, 0.3);
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(138, 43, 226, 0.3);
      }

      .glass-card {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(20px);
        border-radius: 30px;
        padding: 40px;
        border: 2px solid rgba(138, 43, 226, 0.2);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        margin-bottom: 30px;
      }
      .info-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 10px;
      }
      .info-card {
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(15px);
        border-radius: 20px;
        padding: 20px;
        border: 1px solid rgba(138, 43, 226, 0.3);
        text-align: center;
        transition: all 0.3s;
      }
      .info-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 24px rgba(138, 43, 226, 0.3);
      }
      .info-label {
        font-size: 14px;
        color: #a8a8a8;
        margin-bottom: 10px;
      }
      .info-value {
        font-size: 18px;
        font-weight: 700;
        color: #667eea;
        word-break: break-word;
      }

      .ip-fallback {
        text-align: center;
        margin: 12px 0 0;
        font-size: 13px;
        color: rgba(234, 240, 255, 0.7);
      }
      .ip-fallback a {
        color: #8fb3ff;
        text-decoration: none;
        border-bottom: 1px dashed rgba(143, 179, 255, 0.55);
      }
      .ip-fallback a:hover {
        opacity: 0.9;
      }

      .speed-display {
        text-align: center;
        margin: 40px 0;
      }
      .main-speed {
        font-size: 72px;
        font-weight: 800;
        background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 10px;
      }
      .speed-label {
        font-size: 24px;
        color: #a8a8a8;
        margin-bottom: 30px;
      }

      .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      .metric-box {
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(15px);
        border-radius: 20px;
        padding: 25px;
        border: 1px solid rgba(138, 43, 226, 0.3);
        text-align: center;
      }
      .metric-value {
        font-size: 36px;
        font-weight: 800;
        color: #667eea;
        margin-bottom: 5px;
      }
      .metric-label {
        font-size: 14px;
        color: #a8a8a8;
      }

      .chart-container {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(15px);
        border-radius: 20px;
        padding: 30px;
        border: 1px solid rgba(138, 43, 226, 0.3);
        margin-bottom: 20px;
        height: 300px;
        position: relative;
      }
      canvas {
        width: 100% !important;
        height: 100% !important;
      }

      .start-btn {
        background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
        border: none;
        padding: 18px 60px;
        border-radius: 50px;
        font-size: 20px;
        font-weight: 800;
        color: #fff;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 8px 32px rgba(102, 126, 234, 0.4);
        display: block;
        margin: 0 auto;
      }
      .start-btn:hover:not(:disabled) {
        transform: translateY(-3px);
        box-shadow: 0 12px 40px rgba(102, 126, 234, 0.6);
      }
      .start-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .progress-bar {
        width: 100%;
        height: 8px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        overflow: hidden;
        margin: 30px 0;
      }
      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        width: 0%;
        transition: width 0.3s;
        border-radius: 10px;
      }

      .status-text {
        text-align: center;
        color: #a8a8a8;
        font-size: 16px;
        margin-top: 12px;
      }
      .debug {
        margin-top: 14px;
        padding: 12px 14px;
        border-radius: 14px;
        border: 1px solid rgba(138, 43, 226, 0.25);
        background: rgba(255, 255, 255, 0.06);
        font-size: 12px;
        color: rgba(234, 240, 255, 0.85);
        line-height: 1.6;
        white-space: pre-wrap;
        user-select: text;
      }
      [dir="ltr"] {
        text-align: left;
      }
      [dir="ltr"] .info-card,
      [dir="ltr"] .metric-box,
      [dir="ltr"] .speed-display,
      [dir="ltr"] .status-text,
      [dir="ltr"] .ip-fallback {
        text-align: center;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <header>
        <div class="logo-section">
          <div class="logo">MP</div>
          <div class="site-title" data-fa="میرزا پینگ" data-en="Mirza Ping">
            میرزا پینگ
          </div>
        </div>
        <button class="lang-switch" onclick="toggleLang()">
          <span data-fa="English" data-en="فارسی">English</span>
        </button>
      </header>

      <div class="glass-card">
        <div class="info-cards">
          <div class="info-card">
            <div class="info-label" data-fa="آدرس IP" data-en="IP Address">
              آدرس IP
            </div>
            <div class="info-value" id="ip">در حال بارگذاری...</div>
          </div>
          <div class="info-card">
            <div
              class="info-label"
              data-fa="ارائه‌دهنده اینترنت (ISP/AS)"
              data-en="ISP / AS"
            >
              ارائه‌دهنده اینترنت (ISP/AS)
            </div>
            <div class="info-value" id="isp">در حال بارگذاری...</div>
          </div>
        </div>

        <div class="ip-fallback">
          <span data-fa="اگر نمایش IP/ISP مشکل داشت:" data-en="If IP/ISP fails:"
            >اگر نمایش IP/ISP مشکل داشت:</span
          >
          <a href="https://ipv8.net" target="_blank" rel="noopener">ipv8.net</a>
          <span data-fa="را باز کن" data-en="open it">را باز کن</span>
        </div>

        <div class="speed-display">
          <div class="main-speed" id="mainSpeed">0</div>
          <div class="speed-label" data-fa="مگابیت بر ثانیه" data-en="Mbps">
            مگابیت بر ثانیه
          </div>
        </div>

        <div class="metrics-grid">
          <div class="metric-box">
            <div class="metric-value" id="ping">0</div>
            <div class="metric-label" data-fa="پینگ (ms)" data-en="Ping (ms)">
              پینگ (ms)
            </div>
          </div>
          <div class="metric-box">
            <div class="metric-value" id="download">0</div>
            <div
              class="metric-label"
              data-fa="دانلود (Mbps)"
              data-en="Download (Mbps)"
            >
              دانلود (Mbps)
            </div>
          </div>
          <div class="metric-box">
            <div class="metric-value" id="jitter">0</div>
            <div class="metric-label" data-fa="جیتر (ms)" data-en="Jitter (ms)">
              جیتر (ms)
            </div>
          </div>
        </div>

        <div class="chart-container"><canvas id="speedChart"></canvas></div>

        <div class="progress-bar">
          <div class="progress-fill" id="progress"></div>
        </div>

        <div
          class="status-text"
          id="status"
          data-fa="آماده برای شروع تست"
          data-en="Ready to start test"
        >
          آماده برای شروع تست
        </div>

        <button class="start-btn" id="startBtn" onclick="startTest()">
          <span data-fa="شروع تست" data-en="Start Test">شروع تست</span>
        </button>

        <div class="debug" id="debug">Debug: ready.</div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
      let currentLang = "fa";
      let isTestRunning = false;

      const WORKER_URL = "https://speedtest.vcmail.workers.dev".replace(
        /\/+$/,
        ""
      );
      const DOWNLOAD_URL = WORKER_URL + "/down?bytes=25000000";

      const dbgEl = document.getElementById("debug");
      function dbg(msg) {
        const t = new Date().toLocaleTimeString();
        dbgEl.textContent = (`[${t}] ${msg}\n` + dbgEl.textContent).slice(
          0,
          2600
        );
        console.log("[DBG]", msg);
      }

      // Chart
      let chartData = {
        labels: [],
        datasets: [
          {
            label: "Speed (Mbps)",
            data: [],
            borderColor: "#667eea",
            backgroundColor: "rgba(102, 126, 234, 0.1)",
            tension: 0.4,
            fill: true,
            pointRadius: 3,
          },
        ],
      };

      const ctx = document.getElementById("speedChart").getContext("2d");
      const chart = new Chart(ctx, {
        type: "line",
        data: chartData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: {
              beginAtZero: true,
              grid: { color: "rgba(255, 255, 255, 0.1)" },
              ticks: { color: "#a8a8a8", callback: (v) => v + " Mbps" },
            },
            x: {
              grid: { color: "rgba(255, 255, 255, 0.1)" },
              ticks: { color: "#a8a8a8" },
            },
          },
          animation: { duration: 0 },
        },
      });

      function toggleLang() {
        currentLang = currentLang === "fa" ? "en" : "fa";
        document.documentElement.setAttribute("lang", currentLang);
        document.documentElement.setAttribute(
          "dir",
          currentLang === "fa" ? "rtl" : "ltr"
        );
        document.querySelectorAll("[data-fa]").forEach((el) => {
          const text = el.getAttribute("data-" + currentLang);
          if (text) el.textContent = text;
        });
      }

      function sleep(ms) {
        return new Promise((r) => setTimeout(r, ms));
      }

      function fetchWithTimeout(url, timeoutMs = 8000, fetchOptions = {}) {
        const controller = new AbortController();
        const timer = setTimeout(() => controller.abort(), timeoutMs);
        return fetch(url, {
          ...fetchOptions,
          signal: controller.signal,
        }).finally(() => clearTimeout(timer));
      }

      function updateStatus(faText, enText) {
        const statusEl = document.getElementById("status");
        statusEl.setAttribute("data-fa", faText);
        statusEl.setAttribute("data-en", enText);
        statusEl.textContent = currentLang === "fa" ? faText : enText;
      }

      function pushChartPoint(speedMbps, startMs) {
        const elapsed = ((performance.now() - startMs) / 1000).toFixed(1);
        chartData.labels.push(elapsed + "s");
        chartData.datasets[0].data.push(Number(speedMbps.toFixed(2)));
        if (chartData.labels.length > 80) {
          chartData.labels.shift();
          chartData.datasets[0].data.shift();
        }
        chart.update();
      }

      // ----------------------------
      // IP/ISP: Adaptive Providers
      // ----------------------------
      const ISP_STATS_KEY = "mirzaping_isp_provider_stats_v1";

      function loadStats() {
        try {
          return JSON.parse(localStorage.getItem(ISP_STATS_KEY) || "{}");
        } catch {
          return {};
        }
      }
      function saveStats(stats) {
        try {
          localStorage.setItem(ISP_STATS_KEY, JSON.stringify(stats));
        } catch {}
      }

      function recordProviderResult(id, ok, hasIsp, ms) {
        const stats = loadStats();
        const s = stats[id] || {
          tries: 0,
          ok: 0,
          hasIsp: 0,
          msSum: 0,
          msCount: 0,
        };
        s.tries += 1;
        if (ok) s.ok += 1;
        if (hasIsp) s.hasIsp += 1;
        if (typeof ms === "number" && isFinite(ms)) {
          s.msSum += ms;
          s.msCount += 1;
        }
        stats[id] = s;
        saveStats(stats);
      }

      function providerScore(id, fallbackPriority) {
        const stats = loadStats();
        const s = stats[id];
        if (!s || !s.tries) return 1000 - fallbackPriority * 10; // اولویت اولیه
        const okRate = s.ok / s.tries; // 0..1
        const ispRate = s.hasIsp / s.tries; // 0..1
        const avgMs = s.msCount ? s.msSum / s.msCount : 9999;

        // وزن‌دهی: ISP مهم‌تر از سرعت پاسخ
        // امتیاز بالاتر = بهتر
        return (
          okRate * 1000 +
          ispRate * 1200 +
          Math.max(0, 500 - avgMs / 2) +
          (1000 - fallbackPriority * 20)
        );
      }

      function pickFirst(...vals) {
        for (const v of vals)
          if (typeof v === "string" && v.trim()) return v.trim();
        return "";
      }

      function normalizeISPFields(d) {
        const ip = pickFirst(d.ip, d.query, d.address, d.ip_address);

        const isp = pickFirst(
          d.isp,
          d.org,
          d.organization,
          d.asn_organization,
          d.as_org,
          d.asOrganization,
          d.operator,
          d.provider,
          d.company,
          d.company_name
        );

        const connISP = d.connection
          ? pickFirst(d.connection.isp, d.connection.org)
          : "";

        const asName = d.as
          ? pickFirst(d.as.name, d.as.domain, d.as.organization)
          : "";
        const asnRaw = pickFirst(
          d.asn,
          d.as_number ? String(d.as_number) : "",
          d.asn_number ? String(d.asn_number) : "",
          d.as && d.as.asn ? String(d.as.asn) : "",
          d.as && d.as.number ? String(d.as.number) : ""
        );

        const finalIsp = pickFirst(isp, connISP, asName);

        let asLabel = "";
        if (asnRaw) {
          const n = asnRaw.replace(/^AS/i, "");
          if (n) asLabel = "AS" + n;
        } else if (d.as) {
          const n2 = pickFirst(
            d.as.asn ? String(d.as.asn) : "",
            d.as.number ? String(d.as.number) : ""
          );
          if (n2) asLabel = "AS" + n2.replace(/^AS/i, "");
        }

        const label = finalIsp
          ? asLabel
            ? `${finalIsp} (${asLabel})`
            : finalIsp
          : asLabel
          ? asLabel
          : "";

        return { ip, ispLabel: label };
      }

      async function tryJson(url, timeoutMs = 4500) {
        const t0 = performance.now();
        const r = await fetchWithTimeout(url, timeoutMs, { cache: "no-store" });
        const t1 = performance.now();
        if (!r.ok) throw new Error("HTTP_" + r.status);
        const data = await r.json().catch(() => null);
        if (!data) throw new Error("BAD_JSON");
        return { data, ms: t1 - t0 };
      }

      async function tryText(url, timeoutMs = 4500) {
        const t0 = performance.now();
        const r = await fetchWithTimeout(url, timeoutMs, { cache: "no-store" });
        const t1 = performance.now();
        if (!r.ok) throw new Error("HTTP_" + r.status);
        const text = await r.text();
        return { text, ms: t1 - t0 };
      }

      function setIPISP(ip, ispText) {
        document.getElementById("ip").textContent = ip || "Unknown";
        document.getElementById("isp").textContent =
          ispText || (currentLang === "fa" ? "نامشخص" : "Unknown");
      }

      async function getIPInfo() {
        setIPISP("در حال شناسایی...", "در حال شناسایی...");
        dbg("IP/ISP: start");

        // Provider list (بدون API Key) + اولویت اولیه (کمتر = بهتر)
        const providers = [
          // Worker (اگر درست تنظیم شده باشه، بهترینه)
          {
            id: "worker",
            name: "Worker",
            priority: 0,
            run: async () => {
              const { data, ms } = await tryJson(
                WORKER_URL + "/?t=" + Date.now(),
                5500
              );
              const out = normalizeISPFields(data);
              return { ip: out.ip, isp: out.ispLabel, ms };
            },
          },

          // معمولاً برای ایران خوب: ipwho / ipapi / ipinfo / ip-api (بسته به ISP و فیلتر)
          {
            id: "ipwho",
            name: "ipwho.is",
            priority: 1,
            run: async () => {
              const { data, ms } = await tryJson(
                "https://ipwho.is/?t=" + Date.now(),
                4500
              );
              const out = normalizeISPFields(data);
              return { ip: out.ip, isp: out.ispLabel, ms };
            },
          },
          {
            id: "ipapi_co",
            name: "ipapi.co",
            priority: 2,
            run: async () => {
              const { data, ms } = await tryJson(
                "https://ipapi.co/json/?t=" + Date.now(),
                4500
              );
              const out = normalizeISPFields(data);
              // ipapi.co معمولاً org/asn دارد
              const org = pickFirst(data.org, data.asn, data.network);
              const out2 = out.ispLabel || (org ? org : "");
              return { ip: out.ip, isp: out2, ms };
            },
          },
          {
            id: "ipinfo",
            name: "ipinfo.io",
            priority: 3,
            run: async () => {
              const { data, ms } = await tryJson(
                "https://ipinfo.io/json?token=&t=" + Date.now(),
                4500
              );
              // بدون توکن هم معمولاً org را می‌دهد (محدودیت دارد)
              const ip = pickFirst(data.ip);
              const org = pickFirst(data.org); // مثل: "ASXXXX Company Name"
              return { ip, isp: org, ms };
            },
          },
          {
            id: "ipapi_com",
            name: "ip-api.com",
            priority: 4,
            run: async () => {
              const { data, ms } = await tryJson(
                "https://ip-api.com/json/?fields=status,message,query,isp,org,as&lang=en&t=" +
                  Date.now(),
                4500
              );
              const ip = pickFirst(data.query);
              const isp = pickFirst(data.isp, data.org, data.as);
              return { ip, isp, ms };
            },
          },
          {
            id: "ifconfig",
            name: "ifconfig.co",
            priority: 5,
            run: async () => {
              const { data, ms } = await tryJson(
                "https://ifconfig.co/json?t=" + Date.now(),
                4500
              );
              const out = normalizeISPFields(data);
              // ifconfig.co: sometimes "asn_org" / "org"
              const org = pickFirst(data.asn_org, data.org);
              return { ip: out.ip, isp: out.ispLabel || org, ms };
            },
          },
          {
            id: "ipguide",
            name: "ip.guide",
            priority: 6,
            run: async () => {
              const { data, ms } = await tryJson(
                "https://ip.guide/?t=" + Date.now(),
                4500
              );
              // ip.guide format varies; try common fields
              const out = normalizeISPFields(data);
              const ip = out.ip || pickFirst(data.ip);
              const isp =
                out.ispLabel ||
                pickFirst(data.isp, data.org, data.asn?.name, data.as?.name);
              return { ip, isp, ms };
            },
          },
          // این‌ها معمولاً ISP دقیق نمی‌دهند ولی IP را نجات می‌دهند:
          {
            id: "myip",
            name: "api.myip.com",
            priority: 90,
            run: async () => {
              const { data, ms } = await tryJson(
                "https://api.myip.com/?t=" + Date.now(),
                4500
              );
              const ip = pickFirst(data.ip);
              return { ip, isp: "", ms };
            },
          },
          {
            id: "ipify",
            name: "ipify",
            priority: 99,
            run: async () => {
              const { data, ms } = await tryJson(
                "https://api.ipify.org?format=json&t=" + Date.now(),
                4500
              );
              const ip = pickFirst(data.ip);
              return { ip, isp: "", ms };
            },
          },
        ];

        // مرتب‌سازی بر اساس نتایج واقعی کاربران (localStorage)
        const ordered = [...providers].sort((a, b) => {
          const sa = providerScore(a.id, a.priority);
          const sb = providerScore(b.id, b.priority);
          return sb - sa;
        });

        dbg("IP/ISP: provider order = " + ordered.map((p) => p.id).join(", "));

        let bestIp = "";
        let bestIsp = "";

        for (const p of ordered) {
          try {
            dbg("IP/ISP: try " + p.name);
            const r = await p.run();

            const ip = (r.ip || "").trim();
            const isp = (r.isp || "").trim();
            const ok = !!ip;
            const hasIsp = !!isp;

            recordProviderResult(p.id, ok, hasIsp, r.ms);

            // اگر IP گرفتیم، همون لحظه UI رو حداقل با IP پر کن
            if (ip && !bestIp) bestIp = ip;
            if (isp && !bestIsp) bestIsp = isp;

            // اگر هم IP هم ISP داریم، بهترین حالت: تمام
            if (ip && isp) {
              setIPISP(ip, isp);
              dbg(
                `IP/ISP: OK via ${
                  p.name
                } | ip=${ip} | isp=${isp} | ${Math.round(r.ms)}ms`
              );
              return;
            }

            // اگر فقط IP داریم، ادامه بده برای ISP بهتر، ولی UI رو IP بده
            if (ip && !isp) {
              setIPISP(
                ip,
                currentLang === "fa" ? "در حال یافتن ISP..." : "Finding ISP..."
              );
              dbg(
                `IP/ISP: got IP only via ${p.name} | ip=${ip} | ${Math.round(
                  r.ms
                )}ms`
              );
              // ادامه می‌دهیم
            }
          } catch (e) {
            recordProviderResult(p.id, false, false, null);
            dbg("IP/ISP: fail " + p.name + " (" + (e?.message || e) + ")");
          }
        }

        // اگر به ISP نرسیدیم ولی IP داریم:
        if (bestIp) {
          setIPISP(bestIp, currentLang === "fa" ? "نامشخص" : "Unknown");
          dbg("IP/ISP: final (ip only) ip=" + bestIp);
          return;
        }

        setIPISP("Unknown", currentLang === "fa" ? "نامشخص" : "Unknown");
        dbg("IP/ISP: all failed");
      }

      // ---------- Ping ----------
      async function measurePing() {
        updateStatus("در حال تست پینگ...", "Testing ping...");
        dbg("Ping: start");

        const pingResults = [];
        const iterations = 5;

        for (let i = 0; i < iterations; i++) {
          const start = performance.now();
          try {
            await fetchWithTimeout(
              WORKER_URL + "/down?bytes=32&t=" + Date.now(),
              3500,
              { cache: "no-store" }
            );
            const end = performance.now();
            const ping = end - start;
            pingResults.push(ping);
            document.getElementById("ping").textContent = ping.toFixed(0);
            dbg(`Ping sample ${i + 1}/${iterations}: ${ping.toFixed(0)}ms`);
          } catch (e) {
            dbg(
              `Ping sample ${i + 1}/${iterations}: FAIL (${e?.message || e})`
            );
          }
          if (i < iterations - 1) await sleep(450);
        }

        if (!pingResults.length) {
          document.getElementById("ping").textContent = "0";
          document.getElementById("jitter").textContent = "0";
          dbg("Ping: all failed");
          return;
        }

        const avgPing =
          pingResults.reduce((a, b) => a + b, 0) / pingResults.length;
        const jitter = Math.sqrt(
          pingResults
            .map((p) => (p - avgPing) * (p - avgPing))
            .reduce((a, b) => a + b, 0) / pingResults.length
        );

        document.getElementById("ping").textContent = avgPing.toFixed(0);
        document.getElementById("jitter").textContent = jitter.toFixed(1);
        dbg(
          `Ping: done avg=${avgPing.toFixed(0)}ms jitter=${jitter.toFixed(1)}ms`
        );
      }

      // ---------- Download ----------
      async function measureDownload() {
        updateStatus("در حال تست سرعت دانلود...", "Testing download speed...");
        dbg("Download: start");

        const durationMs = 10000;
        const startMs = performance.now();
        let lastTickMs = startMs;
        let bytesSinceTick = 0;
        const speeds = [];

        chartData.labels = [];
        chartData.datasets[0].data = [];
        chart.update();

        while (performance.now() - startMs < durationMs && isTestRunning) {
          try {
            const res = await fetch(DOWNLOAD_URL + "&t=" + Date.now(), {
              cache: "no-store",
            });
            if (!res.body) throw new Error("STREAM_UNSUPPORTED");
            const reader = res.body.getReader();

            while (isTestRunning) {
              const { value, done } = await reader.read();
              if (done) break;

              bytesSinceTick += value.byteLength;
              const now = performance.now();

              if (now - lastTickMs >= 250) {
                const sec = (now - lastTickMs) / 1000;
                const speedMbps = (bytesSinceTick * 8) / (sec * 1e6);

                speeds.push(speedMbps);
                document.getElementById("mainSpeed").textContent =
                  speedMbps.toFixed(2);
                document.getElementById("download").textContent =
                  speedMbps.toFixed(2);
                pushChartPoint(speedMbps, startMs);

                bytesSinceTick = 0;
                lastTickMs = now;

                if (now - startMs >= durationMs) {
                  try {
                    reader.cancel();
                  } catch {}
                  break;
                }
              }
            }
          } catch (e) {
            dbg("Download error: " + (e?.message || e));
            break;
          }
        }

        if (speeds.length) {
          const avg = speeds.reduce((a, b) => a + b, 0) / speeds.length;
          document.getElementById("download").textContent = avg.toFixed(2);
          document.getElementById("mainSpeed").textContent = avg.toFixed(2);
        } else {
          document.getElementById("download").textContent = "0";
          document.getElementById("mainSpeed").textContent = "0";
        }

        dbg("Download: done");
      }

      // ---------- Main ----------
      async function startTest() {
        if (isTestRunning) return;

        const btn = document.getElementById("startBtn");
        const progress = document.getElementById("progress");

        isTestRunning = true;
        btn.disabled = true;

        document.getElementById("mainSpeed").textContent = "0";
        document.getElementById("ping").textContent = "0";
        document.getElementById("download").textContent = "0";
        document.getElementById("jitter").textContent = "0";
        progress.style.width = "0%";

        chartData.labels = [];
        chartData.datasets[0].data = [];
        chart.update();

        dbg("=== START TEST (NO UPLOAD) ===");
        dbg("WORKER_URL=" + WORKER_URL);

        try {
          progress.style.width = "10%";
          await measurePing();
          progress.style.width = "30%";

          await sleep(400);

          progress.style.width = "35%";
          await measureDownload();
          progress.style.width = "100%";

          updateStatus(
            "تست با موفقیت انجام شد!",
            "Test completed successfully!"
          );
          dbg("=== DONE ===");
        } catch (e) {
          dbg("Test error: " + (e?.message || e));
          updateStatus("خطا در انجام تست", "Error during test");
        }

        isTestRunning = false;
        btn.disabled = false;
      }

      // init
      getIPInfo();
    </script>
  </body>
</html>
