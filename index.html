<!DOCTYPE html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mirza Ping - تست سرعت اینترنت</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(
          135deg,
          #1a1a2e 0%,
          #16213e 50%,
          #0f3460 100%
        );
        min-height: 100vh;
        color: #fff;
        overflow-x: hidden;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 0;
        margin-bottom: 40px;
      }

      .logo-section {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .logo {
        width: 60px;
        height: 60px;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        border: 2px solid rgba(138, 43, 226, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        box-shadow: 0 8px 32px rgba(138, 43, 226, 0.2);
      }

      .site-title {
        font-size: 32px;
        font-weight: bold;
        background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .lang-switch {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 2px solid rgba(138, 43, 226, 0.3);
        padding: 10px 20px;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s;
        color: #fff;
        font-size: 14px;
      }

      .lang-switch:hover {
        background: rgba(138, 43, 226, 0.3);
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(138, 43, 226, 0.3);
      }

      .glass-card {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(20px);
        border-radius: 30px;
        padding: 40px;
        border: 2px solid rgba(138, 43, 226, 0.2);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        margin-bottom: 30px;
      }

      .info-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .info-card {
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(15px);
        border-radius: 20px;
        padding: 20px;
        border: 1px solid rgba(138, 43, 226, 0.3);
        text-align: center;
        transition: all 0.3s;
      }

      .info-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 24px rgba(138, 43, 226, 0.3);
      }

      .info-label {
        font-size: 14px;
        color: #a8a8a8;
        margin-bottom: 10px;
      }

      .info-value {
        font-size: 18px;
        font-weight: bold;
        color: #667eea;
      }

      .speed-display {
        text-align: center;
        margin: 40px 0;
      }

      .main-speed {
        font-size: 72px;
        font-weight: bold;
        background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 10px;
      }

      .speed-label {
        font-size: 24px;
        color: #a8a8a8;
        margin-bottom: 30px;
      }

      .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
      }

      .metric-box {
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(15px);
        border-radius: 20px;
        padding: 25px;
        border: 1px solid rgba(138, 43, 226, 0.3);
        text-align: center;
      }

      .metric-value {
        font-size: 36px;
        font-weight: bold;
        color: #667eea;
        margin-bottom: 5px;
      }

      .metric-label {
        font-size: 14px;
        color: #a8a8a8;
      }

      .chart-container {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(15px);
        border-radius: 20px;
        padding: 30px;
        border: 1px solid rgba(138, 43, 226, 0.3);
        margin-bottom: 30px;
        height: 300px;
        position: relative;
      }

      canvas {
        width: 100% !important;
        height: 100% !important;
      }

      .start-btn {
        background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
        border: none;
        padding: 18px 60px;
        border-radius: 50px;
        font-size: 20px;
        font-weight: bold;
        color: #fff;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 8px 32px rgba(102, 126, 234, 0.4);
        display: block;
        margin: 0 auto;
      }

      .start-btn:hover:not(:disabled) {
        transform: translateY(-3px);
        box-shadow: 0 12px 40px rgba(102, 126, 234, 0.6);
      }

      .start-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .progress-bar {
        width: 100%;
        height: 8px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        overflow: hidden;
        margin: 30px 0;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        width: 0%;
        transition: width 0.3s;
        border-radius: 10px;
      }

      .status-text {
        text-align: center;
        color: #a8a8a8;
        font-size: 16px;
        margin-top: 20px;
      }

      [dir="ltr"] {
        text-align: left;
      }

      [dir="ltr"] .info-card,
      [dir="ltr"] .metric-box,
      [dir="ltr"] .speed-display,
      [dir="ltr"] .status-text {
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <div class="logo-section">
          <div class="logo">MP</div>
          <div class="site-title" data-fa="میرزا پینگ" data-en="Mirza Ping">
            میرزا پینگ
          </div>
        </div>
        <button class="lang-switch" onclick="toggleLang()">
          <span data-fa="English" data-en="فارسی">English</span>
        </button>
      </header>

      <div class="glass-card">
        <div class="info-cards">
          <div class="info-card">
            <div class="info-label" data-fa="آدرس IP" data-en="IP Address">
              آدرس IP
            </div>
            <div class="info-value" id="ip">در حال بارگذاری...</div>
          </div>
          <div class="info-card">
            <div class="info-label" data-fa="ارائه‌دهنده اینترنت" data-en="ISP">
              ارائه‌دهنده اینترنت
            </div>
            <div class="info-value" id="isp">در حال بارگذاری...</div>
          </div>
        </div>

        <div class="speed-display">
          <div class="main-speed" id="mainSpeed">0</div>
          <div class="speed-label" data-fa="مگابیت بر ثانیه" data-en="Mbps">
            مگابیت بر ثانیه
          </div>
        </div>

        <div class="metrics-grid">
          <div class="metric-box">
            <div class="metric-value" id="ping">0</div>
            <div class="metric-label" data-fa="پینگ (ms)" data-en="Ping (ms)">
              پینگ (ms)
            </div>
          </div>
          <div class="metric-box">
            <div class="metric-value" id="download">0</div>
            <div
              class="metric-label"
              data-fa="دانلود (Mbps)"
              data-en="Download (Mbps)"
            >
              دانلود (Mbps)
            </div>
          </div>
          <div class="metric-box">
            <div class="metric-value" id="upload">0</div>
            <div
              class="metric-label"
              data-fa="آپلود (Mbps)"
              data-en="Upload (Mbps)"
            >
              آپلود (Mbps)
            </div>
          </div>
          <div class="metric-box">
            <div class="metric-value" id="jitter">0</div>
            <div class="metric-label" data-fa="جیتر (ms)" data-en="Jitter (ms)">
              جیتر (ms)
            </div>
          </div>
        </div>

        <div class="chart-container">
          <canvas id="speedChart"></canvas>
        </div>

        <div class="progress-bar">
          <div class="progress-fill" id="progress"></div>
        </div>

        <div
          class="status-text"
          id="status"
          data-fa="آماده برای شروع تست"
          data-en="Ready to start test"
        >
          آماده برای شروع تست
        </div>

        <button class="start-btn" id="startBtn" onclick="startTest()">
          <span data-fa="شروع تست" data-en="Start Test">شروع تست</span>
        </button>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
      let currentLang = "fa";
      let chart;
      let isTestRunning = false;

      let chartData = {
        labels: [],
        datasets: [
          {
            label: "Speed (Mbps)",
            data: [],
            borderColor: "#667eea",
            backgroundColor: "rgba(102, 126, 234, 0.1)",
            tension: 0.4,
            fill: true,
            pointRadius: 3,
          },
        ],
      };

      const ctx = document.getElementById("speedChart").getContext("2d");
      chart = new Chart(ctx, {
        type: "line",
        data: chartData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: { color: "rgba(255, 255, 255, 0.1)" },
              ticks: {
                color: "#a8a8a8",
                callback: function (value) {
                  return value + " Mbps";
                },
              },
            },
            x: {
              grid: { color: "rgba(255, 255, 255, 0.1)" },
              ticks: { color: "#a8a8a8" },
            },
          },
          animation: { duration: 0 },
        },
      });

      function toggleLang() {
        currentLang = currentLang === "fa" ? "en" : "fa";
        document.documentElement.setAttribute("lang", currentLang);
        document.documentElement.setAttribute(
          "dir",
          currentLang === "fa" ? "rtl" : "ltr"
        );

        document.querySelectorAll("[data-fa]").forEach((el) => {
          const text = el.getAttribute("data-" + currentLang);
          if (text) el.textContent = text;
        });
      }

      // ✅ FIXED: Reliable IP + ISP (ipapi.is with ipinfo.io fallback)
      async function getIPInfo() {
        const setUI = (ip, isp) => {
          document.getElementById("ip").textContent = ip || "Unknown";
          document.getElementById("isp").textContent = isp || "Unknown";
        };

        const fetchWithTimeout = async (url, timeoutMs = 6500) => {
          const controller = new AbortController();
          const timer = setTimeout(() => controller.abort(), timeoutMs);
          try {
            const res = await fetch(url, {
              cache: "no-cache",
              signal: controller.signal,
            });
            return res;
          } finally {
            clearTimeout(timer);
          }
        };

        try {
          // 1) ipapi.is
          const r1 = await fetchWithTimeout("https://api.ipapi.is");
          if (r1.ok) {
            const d1 = await r1.json();
            const ip = d1.ip || d1.ipAddress || "Unknown";
            const isp =
              (d1.company && d1.company.name) ||
              (d1.asn && (d1.asn.org || d1.asn.organization)) ||
              d1.isp ||
              d1.organization ||
              "Unknown";
            setUI(ip, isp);
            return;
          }
          throw new Error("ipapi.is failed");
        } catch (e1) {
          try {
            // 2) fallback: ipinfo.io
            const r2 = await fetchWithTimeout("https://ipinfo.io/json");
            const d2 = await r2.json();

            const ip = d2.ip || "Unknown";

            // org: "ASxxxx Company Name" -> "Company Name"
            let isp = d2.org || d2.hostname || "";
            if (typeof isp === "string") {
              isp = isp.replace(/^AS\d+\s*/i, "").trim();
            }
            setUI(ip, isp || "Unknown");
          } catch (e2) {
            console.error("Error fetching IP info:", e1, e2);
            setUI("Error", "Error");
          }
        }
      }

      function updateStatus(faText, enText) {
        const statusEl = document.getElementById("status");
        statusEl.setAttribute("data-fa", faText);
        statusEl.setAttribute("data-en", enText);
        statusEl.textContent = currentLang === "fa" ? faText : enText;
      }

      // helper: اضافه کردن نقطه لحظه‌ای به چارت
      function pushChartPoint(speedMbps, startMs) {
        const elapsed = ((performance.now() - startMs) / 1000).toFixed(1);
        chartData.labels.push(elapsed + "s");
        chartData.datasets[0].data.push(Number(speedMbps.toFixed(2)));
        chart.update();
      }

      async function measurePing() {
        updateStatus("در حال تست پینگ...", "Testing ping...");
        const pingResults = [];
        const iterations = 5;

        for (let i = 0; i < iterations; i++) {
          const start = performance.now();
          try {
            const img = new Image();
            const loadPromise = new Promise((resolve) => {
              img.onload = resolve;
              img.onerror = resolve;
            });
            img.src = "https://cp.cloudflare.com/generate_204?t=" + Date.now();
            await loadPromise;

            const end = performance.now();
            const ping = end - start;
            pingResults.push(ping);
            document.getElementById("ping").textContent = ping.toFixed(0);
          } catch (error) {
            console.error("Ping error:", error);
          }

          if (i < iterations - 1) {
            await new Promise((resolve) => setTimeout(resolve, 600));
          }
        }

        if (pingResults.length > 0) {
          const avgPing =
            pingResults.reduce((a, b) => a + b, 0) / pingResults.length;
          const jitter = Math.sqrt(
            pingResults
              .map((p) => Math.pow(p - avgPing, 2))
              .reduce((a, b) => a + b, 0) / pingResults.length
          );

          document.getElementById("ping").textContent = avgPing.toFixed(0);
          document.getElementById("jitter").textContent = jitter.toFixed(1);
        }
      }

      // ✅ Real-time download speed (streaming)
      async function measureDownload() {
        updateStatus("در حال تست سرعت دانلود...", "Testing download speed...");
        const durationMs = 10000;

        const startMs = performance.now();
        let lastTickMs = startMs;
        let bytesSinceTick = 0;

        const speeds = [];

        chartData.labels = [];
        chartData.datasets[0].data = [];
        chart.update();

        // یک دانلودِ stream که در طول زمان سرعت لحظه‌ای را حساب کند
        while (performance.now() - startMs < durationMs && isTestRunning) {
          try {
            const res = await fetch(
              "https://speed.cloudflare.com/__down?bytes=25000000",
              { cache: "no-cache" }
            );

            if (!res.body) throw new Error("Streaming not supported");

            const reader = res.body.getReader();

            while (isTestRunning) {
              const { value, done } = await reader.read();
              if (done) break;

              bytesSinceTick += value.byteLength;

              const now = performance.now();
              if (now - lastTickMs >= 250) {
                const sec = (now - lastTickMs) / 1000;
                const speedMbps = (bytesSinceTick * 8) / (sec * 1e6);

                speeds.push(speedMbps);

                // نمایش لحظه‌ای
                document.getElementById("mainSpeed").textContent =
                  speedMbps.toFixed(2);
                document.getElementById("download").textContent =
                  speedMbps.toFixed(2);

                // چارت لحظه‌ای
                pushChartPoint(speedMbps, startMs);

                // reset tick
                bytesSinceTick = 0;
                lastTickMs = now;

                // پایان زمان
                if (now - startMs >= durationMs) {
                  try {
                    reader.cancel();
                  } catch {}
                  break;
                }
              }
            }
          } catch (error) {
            console.error("Download error:", error);
            break;
          }
        }

        if (speeds.length > 0) {
          const avgSpeed = speeds.reduce((a, b) => a + b, 0) / speeds.length;
          document.getElementById("download").textContent = avgSpeed.toFixed(2);
        }
      }

      // ✅ Real-time upload speed (chunked requests)
      async function measureUpload() {
        updateStatus("در حال تست سرعت آپلود...", "Testing upload speed...");
        const durationMs = 10000;

        const startMs = performance.now();
        const speeds = [];

        chartData.labels = [];
        chartData.datasets[0].data = [];
        chart.update();

        // chunk = 256KB (متعادل برای نمایش لحظه‌ای + فشار کمتر)
        const chunkSize = 256 * 1024;
        const chunk = new Uint8Array(chunkSize);
        for (let i = 0; i < chunkSize; i++)
          chunk[i] = (Math.random() * 256) | 0;

        while (performance.now() - startMs < durationMs && isTestRunning) {
          try {
            const t0 = performance.now();
            await fetch("https://speed.cloudflare.com/__up", {
              method: "POST",
              body: chunk,
              cache: "no-cache",
            });
            const t1 = performance.now();

            const sec = (t1 - t0) / 1000;
            const speedMbps = (chunkSize * 8) / (sec * 1e6);

            speeds.push(speedMbps);

            // نمایش لحظه‌ای
            document.getElementById("mainSpeed").textContent =
              speedMbps.toFixed(2);
            document.getElementById("upload").textContent =
              speedMbps.toFixed(2);

            // چارت لحظه‌ای
            pushChartPoint(speedMbps, startMs);
          } catch (error) {
            console.error("Upload error:", error);
            break;
          }
        }

        if (speeds.length > 0) {
          const avgSpeed = speeds.reduce((a, b) => a + b, 0) / speeds.length;
          document.getElementById("upload").textContent = avgSpeed.toFixed(2);
        }
      }

      async function startTest() {
        if (isTestRunning) return;

        const btn = document.getElementById("startBtn");
        const progress = document.getElementById("progress");

        isTestRunning = true;
        btn.disabled = true;

        document.getElementById("mainSpeed").textContent = "0";
        document.getElementById("ping").textContent = "0";
        document.getElementById("download").textContent = "0";
        document.getElementById("upload").textContent = "0";
        document.getElementById("jitter").textContent = "0";
        progress.style.width = "0%";

        chartData.labels = [];
        chartData.datasets[0].data = [];
        chart.update();

        try {
          progress.style.width = "10%";
          await measurePing();
          progress.style.width = "25%";

          await new Promise((resolve) => setTimeout(resolve, 500));

          progress.style.width = "30%";
          await measureDownload();
          progress.style.width = "60%";

          await new Promise((resolve) => setTimeout(resolve, 500));

          progress.style.width = "65%";
          await measureUpload();
          progress.style.width = "100%";

          updateStatus(
            "تست با موفقیت انجام شد!",
            "Test completed successfully!"
          );
        } catch (error) {
          console.error("Test error:", error);
          updateStatus("خطا در انجام تست", "Error during test");
        }

        isTestRunning = false;
        btn.disabled = false;
      }

      getIPInfo();
    </script>
  </body>
</html>
